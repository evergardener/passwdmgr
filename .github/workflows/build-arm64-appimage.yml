name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ä»¥vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0

jobs:
  build-windows-x86_64:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies (Windows)
      run: |
        choco install upx -y

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 cryptography mysql-connector-python pillow pyinstaller
        pip list

    - name: Build Windows EXE (x86_64)
      run: |
        # æ¸…ç†æž„å»ºç›®å½•
        Remove-Item -Recurse -Force dist -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force build -ErrorAction SilentlyContinue
        
        # æ£€æŸ¥å›¾æ ‡æ–‡ä»¶
        $iconFile = "resources/icons/favicon.ico"
        if (-Not (Test-Path $iconFile)) {
            $iconFile = "resources/icons/favicon.png"
        }
        
        # æž„å»ºå‚æ•°
        $pyinstallerArgs = @(
            'main.py',
            '--name=PasswordManager',
            '--windowed',
            '--clean',
            '--onefile',
            '--add-data=resources;resources',
            '--add-data=config.json;.',
            '--add-data=*.db;.',
            '--hidden-import=cryptography',
            '--hidden-import=cryptography.hazmat.backends.openssl',
            '--hidden-import=mysql.connector',
            '--hidden-import=PyQt6',
            '--hidden-import=PIL',
            '--hidden-import=PIL.Image',
            '--hidden-import=PIL.ImageFile',
            '--hidden-import=PIL._imaging',
            '--exclude-module=tkinter'
        )
        
        if (Test-Path $iconFile) {
            $pyinstallerArgs += "--icon=$iconFile"
        }
        
        Write-Output "æž„å»ºå‚æ•°:"
        foreach ($arg in $pyinstallerArgs) {
            Write-Output "  $arg"
        }
        
        # æ‰§è¡Œæž„å»º
        python -m PyInstaller @pyinstallerArgs
        
        # é‡å‘½å
        Move-Item "dist/PasswordManager.exe" "dist/PasswordManager-windows-x86_64.exe"

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-x86_64-exe
        path: dist/PasswordManager-windows-x86_64.exe

  build-linux-arm64-appimage:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies for ARM64 cross-compilation
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libssl-dev \
          libffi-dev \
          python3-dev \
          upx \
          wget \
          file \
          desktop-file-utils \
          libgirepository1.0-dev \
          libcairo2-dev \
          gir1.2-gtk-3.0 \
          qemu-user-static \
          binfmt-support \
          crossbuild-essential-arm64

    - name: Install Python dependencies for ARM64
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 cryptography mysql-connector-python pillow pyinstaller
        pip list

    - name: Build Linux ARM64 executable
      run: |
        # æ¸…ç†æž„å»ºç›®å½•
        rm -rf dist build __pycache__
        
        # æ£€æŸ¥å›¾æ ‡æ–‡ä»¶
        ICON_FILE=""
        if [ -f "resources/icons/favicon.png" ]; then
          ICON_FILE="resources/icons/favicon.png"
        elif [ -f "resources/icons/favicon.ico" ]; then
          ICON_FILE="resources/icons/favicon.ico"
        fi
        
        # æž„å»ºå‚æ•°
        PARAMS=(
          'main.py'
          '--name=PasswordManager'
          '--windowed'
          '--clean'
          '--onefile'
          '--add-data=resources:resources'
          '--add-data=config.json:.'
          '--add-data=*.db:.'
          '--hidden-import=cryptography'
          '--hidden-import=cryptography.hazmat.backends.openssl'
          '--hidden-import=mysql.connector'
          '--hidden-import=PyQt6'
          '--hidden-import=PIL'
          '--hidden-import=PIL.Image'
          '--hidden-import=PIL.ImageFile'
          '--hidden-import=PIL._imaging'
          '--exclude-module=tkinter'
        )
        
        if [ -n "$ICON_FILE" ]; then
          PARAMS+=("--icon=$ICON_FILE")
        fi
        
        echo "æž„å»ºå‚æ•°:"
        printf '  %s\n' "${PARAMS[@]}"
        
        # ä½¿ç”¨ aarch64-linux-gnu-gcc è¿›è¡Œäº¤å‰ç¼–è¯‘
        export CC=aarch64-linux-gnu-gcc
        export CXX=aarch64-linux-gnu-g++
        
        # æ‰§è¡Œæž„å»º
        python -m PyInstaller "${PARAMS[@]}"
        
        echo "âœ… Linux ARM64 å¯æ‰§è¡Œæ–‡ä»¶æž„å»ºå®Œæˆï¼"
        
        # æ£€æŸ¥æ–‡ä»¶æž¶æž„
        file dist/PasswordManager

    - name: Prepare AppDir structure
      run: |
        # åˆ›å»º AppDir ç»“æž„
        mkdir -p PasswordManager.AppDir/usr/bin
        mkdir -p PasswordManager.AppDir/usr/lib
        mkdir -p PasswordManager.AppDir/usr/share/applications
        mkdir -p PasswordManager.AppDir/usr/share/icons/hicolor/256x256/apps
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        cp dist/PasswordManager PasswordManager.AppDir/usr/bin/
        chmod +x PasswordManager.AppDir/usr/bin/PasswordManager
        
        # å¤åˆ¶å›¾æ ‡
        if [ -f "resources/icons/favicon.png" ]; then
          cp resources/icons/favicon.png PasswordManager.AppDir/usr/share/icons/hicolor/256x256/apps/passwordmanager.png
        elif [ -f "resources/icons/favicon.ico" ]; then
          # è½¬æ¢ ICO åˆ° PNGï¼ˆå¦‚æžœéœ€è¦ï¼‰
          sudo apt-get install -y imagemagick
          convert resources/icons/favicon.ico[0] PasswordManager.AppDir/usr/share/icons/hicolor/256x256/apps/passwordmanager.png
        else
          # åˆ›å»ºå ä½ç¬¦å›¾æ ‡
          convert -size 256x256 xc:#4A90E2 -fill white -pointsize 72 -gravity center -draw "text 0,0 'ðŸ”'" PasswordManager.AppDir/usr/share/icons/hicolor/256x256/apps/passwordmanager.png
        fi
        
        # å¤åˆ¶èµ„æºæ–‡ä»¶
        mkdir -p PasswordManager.AppDir/usr/share/passwordmanager
        cp -r resources PasswordManager.AppDir/usr/share/passwordmanager/
        cp config.json PasswordManager.AppDir/usr/share/passwordmanager/ 2>/dev/null || true

    - name: Create .desktop file
      run: |
        cat > PasswordManager.AppDir/passwordmanager.desktop << 'EOF'
[Desktop Entry]
Type=Application
Name=Password Manager
GenericName=Password Manager
Comment=A secure password manager application
Icon=passwordmanager
Exec=passwordmanager
Categories=Utility;Security;
Terminal=false
StartupNotify=true
EOF

    - name: Create AppRun launcher
      run: |
        cat > PasswordManager.AppDir/AppRun << 'EOF'
#!/bin/bash
HERE="$(dirname "$(readlink -f "${0}")")"
export PATH="${HERE}/usr/bin:${PATH}"
export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
export XDG_DATA_DIRS="${HERE}/usr/share:${XDG_DATA_DIRS}"

# è®¾ç½®èµ„æºè·¯å¾„
export RESOURCE_PATH="${HERE}/usr/share/passwordmanager/resources"
export CONFIG_PATH="${HERE}/usr/share/passwordmanager/config.json"

exec "${HERE}/usr/bin/PasswordManager"
EOF
        chmod +x PasswordManager.AppDir/AppRun

    - name: Download and use appimagetool
      run: |
        # ä¸‹è½½ appimagetool
        wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool.AppImage
        chmod +x appimagetool.AppImage
        
        # æå– appimagetool
        ./appimagetool.AppImage --appimage-extract
        mv squashfs-root appimagetool
        
        # ä½¿ç”¨ appimagetool æž„å»º AppImage
        ARCH=aarch64 ./appimagetool/AppRun PasswordManager.AppDir
        
        # é‡å‘½åè¾“å‡ºæ–‡ä»¶
        mv PasswordManager*.AppImage PasswordManager-linux-arm64.AppImage

    - name: Upload Linux AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-arm64-appimage
        path: PasswordManager-linux-arm64.AppImage

  create-release:
    runs-on: ubuntu-latest
    needs: [build-windows-x86_64, build-linux-arm64-appimage]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: windows-x86_64-exe
        path: artifacts/windows

    - name: Download Linux AppImage artifact
      uses: actions/download-artifact@v4
      with:
        name: linux-arm64-appimage
        path: artifacts/linux

    - name: Display file information
      run: |
        echo "=== ç”Ÿæˆçš„æ–‡ä»¶ ==="
        find artifacts -type f -exec ls -lh {} \;
        echo "=== æ–‡ä»¶è¯¦æƒ… ==="
        file artifacts/windows/* 2>/dev/null || true
        file artifacts/linux/* 2>/dev/null || true

    - name: Create GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          artifacts/windows/PasswordManager-windows-x86_64.exe
          artifacts/linux/PasswordManager-linux-arm64.AppImage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}