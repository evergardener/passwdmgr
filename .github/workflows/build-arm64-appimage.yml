name: Build Multi-Platform Releases

on:
  workflow_dispatch:  # 允许手动触发
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      build_windows:
        description: 'Build Windows x86_64'
        required: true
        type: boolean
        default: true
      build_arm64_qt5:
        description: 'Build ARM64 Qt5 AppImage'
        required: true
        type: boolean
        default: true
      build_arm64_qt6:
        description: 'Build ARM64 Qt6 AppImage'
        required: true
        type: boolean
        default: true
  push:
    tags:
      - 'v*'  # 推送标签时自动触发

env:
  BUILD_WINDOWS: ${{ github.event.inputs.build_windows || true }}
  BUILD_ARM64_QT5: ${{ github.event.inputs.build_arm64_qt5 || true }}
  BUILD_ARM64_QT6: ${{ github.event.inputs.build_arm64_qt6 || true }}
  VERSION: ${{ github.event.inputs.version || github.ref_name }}

jobs:
  build-windows-x64:
    if: ${{ env.BUILD_WINDOWS == 'true' }}
    runs-on: windows-latest
    name: Build Windows x64 Executable
    outputs:
      upload-name: PasswordManager-${{ env.VERSION }}-windows-x64.exe
      upload-path: dist/PasswordManager.exe

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        architecture: 'x64'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller pillow

    - name: Build Windows executable
      run: |
        python build_exe.py --windows
        # 重命名输出文件
        if (Test-Path "dist/PasswordManager.exe") {
          Move-Item "dist/PasswordManager.exe" "dist/PasswordManager-${{ env.VERSION }}-windows-x64.exe"
        }

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-x64
        path: |
          dist/PasswordManager-${{ env.VERSION }}-windows-x64.exe
        retention-days: 7

  build-linux-arm64-qt5:
    if: ${{ env.BUILD_ARM64_QT5 == 'true' }}
    runs-on: ubuntu-latest  # 使用x64主机运行ARM容器
    name: Build Linux ARM64 Qt5 AppImage
    container:
      image: arm64v8/debian:buster-slim
      options: --privileged  # 需要特权模式运行fuse
    outputs:
      upload-name: PasswordManager-${{ env.VERSION }}-linux-arm64-qt5.AppImage
      upload-path: PasswordManager-${{ env.VERSION }}-linux-arm64-qt5.AppImage

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install system dependencies (ARM64 Debian Buster)
      run: |
        apt-get update
        apt-get install -y \
          python3 \
          python3-pip \
          vim \
          python3-pyqt5 \
          pyqt5-dev \
          libmariadb-dev-compat \
          libffi-dev \
          libjpeg-dev \
          wget \
          file \
          libfuse2 \
          build-essential \
          python3-dev \
          libgl1-mesa-dev \
          libgstreamer-plugins-base1.0-dev \
          qt5-default \
          qttools5-dev-tools

    - name: Upgrade build tools
      run: |
        pip3 install --upgrade pip setuptools wheel

    - name: Install Python dependencies
      run: |
        pip3 install \
          altgraph==0.17.5 \
          cairocffi==1.7.1 \
          CairoSVG==2.8.2 \
          cffi==2.0.0 \
          cryptography==46.0.3 \
          cssselect2==0.8.0 \
          defusedxml==0.7.1 \
          mysql==0.0.3 \
          mysql-connector-python==9.5.0 \
          mysqlclient==2.2.7 \
          packaging==25.0 \
          pillow==12.0.0 \
          pycparser==2.23 \
          pyinstaller==6.17.0 \
          pyinstaller-hooks-contrib==2025.10 \
          PyQt5==5.15.11 \
          PyQt5-Qt5==5.15.2 \
          PyQt5_sip==12.17.1 \
          setuptools==80.9.0 \
          tinycss2==1.5.1 \
          webencodings==0.5.1

    - name: Set Python 3 as default
      run: |
        update-alternatives --install /usr/bin/python python /usr/bin/python3 1

    - name: Build Qt5 AppImage
      run: |
        python build_arm64_qt5.py
        # 重命名输出文件
        if [ -f "PasswordManager-arm64.AppImage" ]; then
          mv "PasswordManager-arm64.AppImage" "PasswordManager-${{ env.VERSION }}-linux-arm64-qt5.AppImage"
        fi

    - name: Upload Qt5 artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-arm64-qt5
        path: |
          PasswordManager-${{ env.VERSION }}-linux-arm64-qt5.AppImage
        retention-days: 7

  build-linux-arm64-qt6:
    if: ${{ env.BUILD_ARM64_QT6 == 'true' }}
    runs-on: ubuntu-latest  # 使用x64主机运行ARM容器
    name: Build Linux ARM64 Qt6 AppImage
    container:
      image: arm64v8/debian:bullseye-slim  # 使用较新版本以支持Qt6
      options: --privileged
    outputs:
      upload-name: PasswordManager-${{ env.VERSION }}-linux-arm64-qt6.AppImage
      upload-path: PasswordManager-${{ env.VERSION }}-linux-arm64-qt6.AppImage

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install system dependencies (ARM64 Debian Bullseye)
      run: |
        apt-get update
        apt-get install -y \
          python3 \
          python3-pip \
          wget \
          file \
          libfuse2 \
          build-essential \
          python3-dev \
          libgl1-mesa-dev \
          libgstreamer-plugins-base1.0-dev \
          qt6-base-dev \
          qt6-tools-dev \
          qt6-tools-dev-tools \
          libmariadb-dev-compat \
          libffi-dev \
          libjpeg-dev

    - name: Upgrade build tools
      run: |
        pip3 install --upgrade pip setuptools wheel

    - name: Install Python dependencies
      run: |
        pip3 install \
          altgraph==0.17.5 \
          cairocffi==1.7.1 \
          CairoSVG==2.8.2 \
          cffi==2.0.0 \
          cryptography==46.0.3 \
          cssselect2==0.8.0 \
          defusedxml==0.7.1 \
          mysql==0.0.3 \
          mysql-connector-python==9.5.0 \
          mysqlclient==2.2.7 \
          packaging==25.0 \
          pillow==12.0.0 \
          pycparser==2.23 \
          pyinstaller==6.17.0 \
          pyinstaller-hooks-contrib==2025.10 \
          PyQt6==6.5.0 \
          setuptools==80.9.0 \
          tinycss2==1.5.1 \
          webencodings==0.5.1

    - name: Set Python 3 as default
      run: |
        update-alternatives --install /usr/bin/python python /usr/bin/python3 1

    - name: Build Qt6 AppImage
      run: |
        python build_arm64_qt6.py
        # 重命名输出文件
        if [ -f "PasswordManager-arm64.AppImage" ]; then
          mv "PasswordManager-arm64.AppImage" "PasswordManager-${{ env.VERSION }}-linux-arm64-qt6.AppImage"
        fi

    - name: Upload Qt6 artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-arm64-qt6
        path: |
          PasswordManager-${{ env.VERSION }}-linux-arm64-qt6.AppImage
        retention-days: 7

  create-release:
    needs: [build-windows-x64, build-linux-arm64-qt5, build-linux-arm64-qt6]
    if: always() && (needs.build-windows-x64.result == 'success' || needs.build-linux-arm64-qt5.result == 'success' || needs.build-linux-arm64-qt6.result == 'success')
    runs-on: ubuntu-latest
    name: Create Release
    permissions:
      contents: write  # 需要权限来创建发布版

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: List downloaded artifacts
      run: |
        echo "下载的构建产物:"
        find . -name "*.exe" -o -name "*.AppImage" | xargs ls -lh

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        name: "Password Manager ${{ env.VERSION }}"
        body: |
          # Password Manager ${{ env.VERSION }}
          
          多平台构建版本，包含：
          - Windows x86_64 可执行文件
          - Linux ARM64 Qt5 AppImage
          - Linux ARM64 Qt6 AppImage
          
          ## 使用说明
          
          ### Windows
          - 下载 `PasswordManager-${{ env.VERSION }}-windows-x64.exe`
          - 直接运行即可
          
          ### Linux ARM64
          - 下载对应的AppImage文件
          - 赋予执行权限：`chmod +x PasswordManager-*.AppImage`
          - 直接运行：`./PasswordManager-*.AppImage`
          
          ## 构建环境
          - Qt5 构建：arm64v8/debian:buster-slim (Python 3.7)
          - Qt6 构建：arm64v8/debian:bullseye-slim
          - 构建时间：${{ github.event.created_at }}
          - 触发事件：${{ github.event_name }}
          - 提交：${{ github.sha }}
        draft: false
        prerelease: false
        files: |
          windows-x64/*.exe
          linux-arm64-qt5/*.AppImage
          linux-arm64-qt6/*.AppImage

  notify-completion:
    needs: [create-release]
    runs-on: ubuntu-latest
    name: Notify Completion
    if: always()

    steps:
    - name: Build Status Summary
      run: |
        echo "构建完成状态报告" > $GITHUB_STEP_SUMMARY
        echo "=================" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## Windows x64 构建" >> $GITHUB_STEP_SUMMARY
        echo "- 状态: ${{ needs.build-windows-x64.result || '未执行' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## Linux ARM64 Qt5 构建" >> $GITHUB_STEP_SUMMARY
        echo "- 状态: ${{ needs.build-linux-arm64-qt5.result || '未执行' }}" >> $GITHUB_STEP_SUMMARY
        echo "- 容器: arm64v8/debian:buster-slim" >> $GITHUB_STEP_SUMMARY
        echo "- Python: 3.7" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## Linux ARM64 Qt6 构建" >> $GITHUB_STEP_SUMMARY
        echo "- 状态: ${{ needs.build-linux-arm64-qt6.result || '未执行' }}" >> $GITHUB_STEP_SUMMARY
        echo "- 容器: arm64v8/debian:bullseye-slim" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## 发布状态" >> $GITHUB_STEP_SUMMARY
        echo "- 状态: ${{ needs.create-release.result || '未执行' }}" >> $GITHUB_STEP_SUMMARY
        echo "- 版本: ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY