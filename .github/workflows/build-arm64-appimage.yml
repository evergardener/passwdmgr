name: Multi-Platform Build (Win & ARM64)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  # ==========================================================
  # ä»»åŠ¡ä¸€ï¼šæ„å»º Windows EXE å¯æ‰§è¡Œç¨‹åº (å·²ä¿®å¤ ParserError)
  # ==========================================================
  build-windows-exe:
    runs-on: windows-latest
    name: Build Windows EXE

    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          # é™ä½ Python ç‰ˆæœ¬ï¼Œä»¥æé«˜ä¸ PyInstaller çš„å…¼å®¹æ€§
          python-version: '3.10'

      - name: âš™ï¸ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          # ç¡®ä¿åœ¨æœ¬åœ°æˆ–ä»“åº“ä¸­ï¼Œä½ å·²ç»ç§»é™¤äº† requirements.txt ä¸­ç¡¬ç¼–ç çš„ 'cffi==2.0.0'
          pip install -r requirements.txt
          pip install pyinstaller

      - name: ğŸ”¨ Build EXE with PyInstaller (ä½¿ç”¨ä¸€è¡Œå‘½ä»¤)
        # Windows Runner é»˜è®¤ä½¿ç”¨ PowerShell (pwsh)ï¼Œé¿å…ä½¿ç”¨ PowerShell çš„æ¢è¡Œç¬¦ '^' å¯¼è‡´çš„è§£æé—®é¢˜
        # æ³¨æ„èµ„æºåˆ†éš”ç¬¦æ˜¯ ';'
        run: pyinstaller --clean --noconfirm --onefile --windowed --add-data "assets;assets" --name "passwdmgr-win-x64.exe" main.py

      - name: â¬†ï¸ Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PasswdMgr-Windows-x64
          path: dist/passwdmgr-win-x64.exe

  # ==========================================================
  # ä»»åŠ¡äºŒï¼šæ„å»º ARM64 AppImage (å·²ä¿®å¤ cffi ä¾èµ–é”™è¯¯)
  # ==========================================================
  build-arm64-appimage:
    runs-on: ubuntu-latest
    name: Build ARM64 AppImage

    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ§ Setup ARM64 Build Environment (QEMU)
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu20.04
          githubToken: ${{ github.token }}

          run: |
            # 1. å®‰è£…ç³»ç»Ÿä¾èµ–
            apt-get update
            apt-get install -y python3-pip python3-venv python3-dev \
                               libgl1-mesa-dev libegl1-mesa libxkbcommon-x11-0 \
                               libdbus-1-3 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 \
                               libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 \
                               libxcb-xfixes0 wget file fuse

            # 2. Python Setup and Dependencies
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            # è¿™é‡Œçš„ pip install ä¼šè‡ªåŠ¨å¯»æ‰¾ cffi çš„å…¼å®¹ç‰ˆæœ¬
            pip install -r requirements.txt 
            pip install pyinstaller

            # 3. PyInstaller Build (Linux èµ„æºåˆ†éš”ç¬¦æ˜¯ ':')
            pyinstaller --clean --noconfirm --distpath dist --workpath build \
                        --name "passwdmgr" \
                        --windowed \
                        --add-data "assets:assets" \
                        main.py

            # 4. AppImage ç›®å½•ç»“æ„å’Œå…ƒæ•°æ®å‡†å¤‡
            mkdir -p AppDir
            cp -r dist/passwdmgr/* AppDir/
            # å‡è®¾ app.desktop å’Œ icon.png å­˜åœ¨
            cp app.desktop AppDir/
            cp icon.png AppDir/
            ln -sr AppDir/passwdmgr AppDir/AppRun

            # 5. AppImage æ‰“åŒ…å·¥å…·ä¸‹è½½ä¸è¿è¡Œ
            wget https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-aarch64.AppImage
            chmod +x appimagetool-aarch64.AppImage
            ./appimagetool-aarch64.AppImage --appimage-extract
            mv squashfs-root tool
            
            ARCH=arm64 ./tool/AppRun AppDir passwdmgr-aarch64.AppImage
            
            mv passwdmgr-aarch64.AppImage ../passwdmgr-aarch64.AppImage

      - name: â¬†ï¸ Upload Linux ARM64 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PasswdMgr-ARM64-AppImage
          path: passwdmgr-aarch64.AppImage