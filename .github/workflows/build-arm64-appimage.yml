name: Multi-Platform Build (Win & ARM64)

on:
  # å½“æ¨é€å¸¦æœ‰ 'v' å¼€å¤´çš„ Tag æ—¶è§¦å‘æ„å»º
  push:
    tags:
      - 'v*'
  # å…è®¸æ‰‹åŠ¨åœ¨ GitHub é¡µé¢ä¸Šè§¦å‘
  workflow_dispatch:

jobs:
  # ==========================================================
  # ä»»åŠ¡ä¸€ï¼šæ„å»º Windows EXE å¯æ‰§è¡Œç¨‹åº (x64)
  # ==========================================================
  build-windows-exe:
    runs-on: windows-latest
    name: Build Windows EXE

    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: âš™ï¸ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: ğŸ”¨ Build EXE with PyInstaller
        # æ³¨æ„ï¼šWindows å‘½ä»¤ä½¿ç”¨ '^' è¿›è¡Œæ¢è¡Œï¼Œä¸”èµ„æºåˆ†éš”ç¬¦æ˜¯ ';'
        run: |
          pyinstaller --clean --noconfirm --onefile --windowed ^
                      --add-data "assets;assets" ^
                      --name "passwdmgr-win-x64.exe" ^
                      main.py

      - name: â¬†ï¸ Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PasswdMgr-Windows-x64
          path: dist/passwdmgr-win-x64.exe

  # ==========================================================
  # ä»»åŠ¡äºŒï¼šæ„å»º ARM64 AppImage (Linux)
  # ä¾èµ–äº QEMU è·¨æ¶æ„æ¨¡æ‹Ÿ
  # ==========================================================
  build-arm64-appimage:
    runs-on: ubuntu-latest
    name: Build ARM64 AppImage

    # å¯é€‰ï¼šå¦‚æœå¸Œæœ› Windows å…ˆè·‘å®Œï¼Œå¯ä»¥æ·»åŠ  needs: [build-windows-exe]

    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ§ Setup ARM64 Build Environment (QEMU)
        # ä½¿ç”¨ uraimo/run-on-arch-action åœ¨ x64 Runner ä¸Šæ¨¡æ‹Ÿ ARM64 ç¯å¢ƒ
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          # ä½¿ç”¨ Ubuntu 20.04 ç¡®ä¿ AppImage å…¼å®¹æ€§
          distro: ubuntu20.04
          githubToken: ${{ github.token }}

          run: |
            # 1. å®‰è£…ç³»ç»Ÿä¾èµ– (Qt/PyQt6 è¿è¡Œæ—¶æ‰€éœ€çš„æ ¸å¿ƒåº“)
            apt-get update
            apt-get install -y python3-pip python3-venv python3-dev \
                               libgl1-mesa-dev libegl1-mesa libxkbcommon-x11-0 \
                               libdbus-1-3 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 \
                               libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 \
                               libxcb-xfixes0 wget file fuse

            # 2. Python Setup and Dependencies
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            pip install pyinstaller

            # 3. PyInstaller Build (AppImage éœ€è¦ç›®å½•æ¨¡å¼)
            # æ³¨æ„ï¼šLinux èµ„æºåˆ†éš”ç¬¦æ˜¯ ':'
            pyinstaller --clean --noconfirm --distpath dist --workpath build \
                        --name "passwdmgr" \
                        --windowed \
                        --add-data "assets:assets" \
                        main.py

            # 4. AppImage ç›®å½•ç»“æ„å’Œå…ƒæ•°æ®å‡†å¤‡ (éœ€è¦ç¡®ä¿ app.desktop å’Œ icon.png å­˜åœ¨äºé¡¹ç›®æ ¹ç›®å½•)
            mkdir -p AppDir
            cp -r dist/passwdmgr/* AppDir/
            cp app.desktop AppDir/
            cp icon.png AppDir/
            ln -sr AppDir/passwdmgr AppDir/AppRun

            # 5. AppImage æ‰“åŒ…å·¥å…·ä¸‹è½½ä¸è¿è¡Œ
            wget https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-aarch64.AppImage
            chmod +x appimagetool-aarch64.AppImage
            # è§£å‹å·¥å…·å¹¶åœ¨å®¹å™¨å†…è¿è¡Œï¼ˆç»•è¿‡ FUSE é™åˆ¶ï¼‰
            ./appimagetool-aarch64.AppImage --appimage-extract
            mv squashfs-root tool
            
            # ä½¿ç”¨ ARCH=arm64 ç¯å¢ƒå˜é‡è¿›è¡Œæ‰“åŒ…
            ARCH=arm64 ./tool/AppRun AppDir passwdmgr-aarch64.AppImage
            
            # å°†æœ€ç»ˆæ–‡ä»¶ç§»å‡ºå·¥ä½œç›®å½•
            mv passwdmgr-aarch64.AppImage ../passwdmgr-aarch64.AppImage

      - name: â¬†ï¸ Upload Linux ARM64 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PasswdMgr-ARM64-AppImage
          path: passwdmgr-aarch64.AppImage