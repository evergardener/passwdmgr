name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows-x86_64:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies (Windows)
      run: |
        choco install upx -y

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 cryptography mysql-connector-python pillow pyinstaller
        pip list

    - name: Build Windows EXE (x86_64)
      run: |
        # æ¸…ç†æž„å»ºç›®å½•
        Remove-Item -Recurse -Force dist -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force build -ErrorAction SilentlyContinue
        
        # æ£€æŸ¥å›¾æ ‡æ–‡ä»¶
        $iconFile = "resources/icons/favicon.ico"
        if (-Not (Test-Path $iconFile)) {
            $iconFile = "resources/icons/favicon.png"
        }
        
        # æž„å»ºå‚æ•°
        $pyinstallerArgs = @(
            'main.py',
            '--name=PasswordManager',
            '--windowed',
            '--clean',
            '--onefile',
            '--add-data=resources;resources',
            '--add-data=config.json;.',
            '--add-data=*.db;.',
            '--hidden-import=cryptography',
            '--hidden-import=cryptography.hazmat.backends.openssl',
            '--hidden-import=mysql.connector',
            '--hidden-import=PyQt6',
            '--hidden-import=PIL',
            '--hidden-import=PIL.Image',
            '--hidden-import=PIL.ImageFile',
            '--hidden-import=PIL._imaging',
            '--exclude-module=tkinter'
        )
        
        if (Test-Path $iconFile) {
            $pyinstallerArgs += "--icon=$iconFile"
        }
        
        Write-Output "æž„å»ºå‚æ•°:"
        foreach ($arg in $pyinstallerArgs) {
            Write-Output "  $arg"
        }
        
        # æ‰§è¡Œæž„å»º
        python -m PyInstaller @pyinstallerArgs
        
        # é‡å‘½å
        Move-Item "dist/PasswordManager.exe" "dist/PasswordManager-windows-x86_64.exe"

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-x86_64-exe
        path: dist/PasswordManager-windows-x86_64.exe

  build-linux-arm64-appimage:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies for ARM64 cross-compilation
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libssl-dev \
          libffi-dev \
          python3-dev \
          upx \
          wget \
          file \
          desktop-file-utils \
          libgirepository1.0-dev \
          libcairo2-dev \
          gir1.2-gtk-3.0 \
          qemu-user-static \
          binfmt-support \
          crossbuild-essential-arm64

    - name: Install Python dependencies for ARM64
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 cryptography mysql-connector-python pillow pyinstaller
        pip list

    - name: Build Linux ARM64 executable
      run: |
        # æ¸…ç†æž„å»ºç›®å½•
        rm -rf dist build __pycache__
        
        # æ£€æŸ¥å›¾æ ‡æ–‡ä»¶
        ICON_FILE=""
        if [ -f "resources/icons/favicon.png" ]; then
          ICON_FILE="resources/icons/favicon.png"
        elif [ -f "resources/icons/favicon.ico" ]; then
          ICON_FILE="resources/icons/favicon.ico"
        fi
        
        # æž„å»ºå‚æ•°
        PARAMS=(
          'main.py'
          '--name=PasswordManager'
          '--windowed'
          '--clean'
          '--onefile'
          '--add-data=resources:resources'
          '--add-data=config.json:.'
          '--add-data=*.db:.'
          '--hidden-import=cryptography'
          '--hidden-import=cryptography.hazmat.backends.openssl'
          '--hidden-import=mysql.connector'
          '--hidden-import=PyQt6'
          '--hidden-import=PIL'
          '--hidden-import=PIL.Image'
          '--hidden-import=PIL.ImageFile'
          '--hidden-import=PIL._imaging'
          '--exclude-module=tkinter'
        )
        
        if [ -n "$ICON_FILE" ]; then
          PARAMS+=("--icon=$ICON_FILE")
        fi
        
        echo "æž„å»ºå‚æ•°:"
        printf '  %s\n' "${PARAMS[@]}"
        
        # ä½¿ç”¨ aarch64-linux-gnu-gcc è¿›è¡Œäº¤å‰ç¼–è¯‘
        export CC=aarch64-linux-gnu-gcc
        export CXX=aarch64-linux-gnu-g++
        
        # æ‰§è¡Œæž„å»º
        python -m PyInstaller "${PARAMS[@]}"
        
        echo "âœ… Linux ARM64 å¯æ‰§è¡Œæ–‡ä»¶æž„å»ºå®Œæˆï¼"
        
        # æ£€æŸ¥æ–‡ä»¶æž¶æž„
        file dist/PasswordManager

    - name: Prepare AppDir structure
      run: |
        # åˆ›å»º AppDir ç»“æž„
        mkdir -p PasswordManager.AppDir/usr/bin
        mkdir -p PasswordManager.AppDir/usr/lib
        mkdir -p PasswordManager.AppDir/usr/share/applications
        mkdir -p PasswordManager.AppDir/usr/share/icons/hicolor/256x256/apps
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        cp dist/PasswordManager PasswordManager.AppDir/usr/bin/
        chmod +x PasswordManager.AppDir/usr/bin/PasswordManager
        
        # å¤åˆ¶å›¾æ ‡
        if [ -f "resources/icons/favicon.png" ]; then
          cp resources/icons/favicon.png PasswordManager.AppDir/usr/share/icons/hicolor/256x256/apps/passwordmanager.png
        elif [ -f "resources/icons/favicon.ico" ]; then
          # è½¬æ¢ ICO åˆ° PNGï¼ˆå¦‚æžœéœ€è¦ï¼‰
          sudo apt-get install -y imagemagick
          convert resources/icons/favicon.ico[0] PasswordManager.AppDir/usr/share/icons/hicolor/256x256/apps/passwordmanager.png
        else
          # åˆ›å»ºå ä½ç¬¦å›¾æ ‡
          convert -size 256x256 xc:#4A90E2 -fill white -pointsize 72 -gravity center -draw "text 0,0 'ðŸ”'" PasswordManager.AppDir/usr/share/icons/hicolor/256x256/apps/passwordmanager.png
        fi
        
        # å¤åˆ¶èµ„æºæ–‡ä»¶
        mkdir -p PasswordManager.AppDir/usr/share/passwordmanager
        cp -r resources PasswordManager.AppDir/usr/share/passwordmanager/
        cp config.json PasswordManager.AppDir/usr/share/passwordmanager/ 2>/dev/null || true

    - name: Create .desktop file
      run: |
        echo '[Desktop Entry]' > PasswordManager.AppDir/passwordmanager.desktop
        echo 'Type=Application' >> PasswordManager.AppDir/passwordmanager.desktop
        echo 'Name=Password Manager' >> PasswordManager.AppDir/passwordmanager.desktop
        echo 'GenericName=Password Manager' >> PasswordManager.AppDir/passwordmanager.desktop
        echo 'Comment=A secure password manager application' >> PasswordManager.AppDir/passwordmanager.desktop
        echo 'Icon=passwordmanager' >> PasswordManager.AppDir/passwordmanager.desktop
        echo 'Exec=passwordmanager' >> PasswordManager.AppDir/passwordmanager.desktop
        echo 'Categories=Utility;Security;Settings' >> PasswordManager.AppDir/passwordmanager.desktop
        echo 'Terminal=false' >> PasswordManager.AppDir/passwordmanager.desktop
        echo 'StartupNotify=true' >> PasswordManager.AppDir/passwordmanager.desktop

    - name: Create AppRun launcher
      run: |
        echo '#!/bin/bash' > PasswordManager.AppDir/AppRun
        echo 'HERE="$(dirname "$(readlink -f "${0}")")"' >> PasswordManager.AppDir/AppRun
        echo 'export PATH="${HERE}/usr/bin:${PATH}"' >> PasswordManager.AppDir/AppRun
        echo 'export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"' >> PasswordManager.AppDir/AppRun
        echo 'export XDG_DATA_DIRS="${HERE}/usr/share:${XDG_DATA_DIRS}"' >> PasswordManager.AppDir/AppRun
        echo '' >> PasswordManager.AppDir/AppRun
        echo '# è®¾ç½®èµ„æºè·¯å¾„' >> PasswordManager.AppDir/AppRun
        echo 'export RESOURCE_PATH="${HERE}/usr/share/passwordmanager/resources"' >> PasswordManager.AppDir/AppRun
        echo 'export CONFIG_PATH="${HERE}/usr/share/passwordmanager/config.json"' >> PasswordManager.AppDir/AppRun
        echo '' >> PasswordManager.AppDir/AppRun
        echo 'exec "${HERE}/usr/bin/PasswordManager"' >> PasswordManager.AppDir/AppRun
        
        chmod +x PasswordManager.AppDir/AppRun

    - name: Download and use appimagetool
      run: |
        # 1. ä¿®æ­£å›¾æ ‡ä½ç½®ï¼šåœ¨AppDiræ ¹ç›®å½•åˆ›å»ºå›¾æ ‡é“¾æŽ¥ï¼ˆè§£å†³ç¬¬äºŒä¸ªè­¦å‘Šï¼‰
        # å·¥å…·æœŸæœ›åœ¨æ ¹ç›®å½•æ‰¾åˆ°åä¸º passwordmanager.png çš„å›¾æ ‡
        if [ -f "PasswordManager.AppDir/usr/share/icons/hicolor/256x256/apps/passwordmanager.png" ]; then
          ln -sf "usr/share/icons/hicolor/256x256/apps/passwordmanager.png" "PasswordManager.AppDir/passwordmanager.png"
        fi

        # 2. ä¸‹è½½ appimagetool çš„ ARM64 ç‰ˆæœ¬ï¼ˆå…³é”®ä¿®æ­£ï¼‰
        # ä½¿ç”¨ä¸“é—¨ä¸ºaarch64æž¶æž„æž„å»ºçš„ç‰ˆæœ¬ï¼Œä»Žæ ¹æœ¬ä¸Šé¿å…æž¶æž„è¯†åˆ«é”™è¯¯
        wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage -O appimagetool-aarch64.AppImage
        chmod +x appimagetool-aarch64.AppImage

        # 3. ä½¿ç”¨æ­£ç¡®çš„å·¥å…·å’Œè¯­æ³•è¿›è¡Œæ‰“åŒ…
        # å…³é”®ï¼šç›´æŽ¥è¿è¡ŒARM64ç‰ˆæœ¬çš„å·¥å…·ï¼Œå®ƒä¼šè‡ªåŠ¨è¯†åˆ«å¹¶è¾“å‡ºæ­£ç¡®çš„æž¶æž„
        ./appimagetool-aarch64.AppImage PasswordManager.AppDir

        # 4. é‡å‘½åè¾“å‡ºæ–‡ä»¶ï¼ˆçŽ°åœ¨ç”Ÿæˆçš„åº”è¯¥æ˜¯aarch64æž¶æž„çš„æ–‡ä»¶ï¼‰
        # æ³¨æ„ï¼šè¿™é‡ŒåŒ¹é…çš„æ–‡ä»¶åæ¨¡å¼å¯èƒ½å·²å˜ï¼Œä½¿ç”¨é€šé…ç¬¦æ›´å®‰å…¨
        mv Password_Manager*.AppImage PasswordManager-linux-arm64.AppImage 2>/dev/null || mv PasswordManager*.AppImage PasswordManager-linux-arm64.AppImage

    - name: Upload Linux AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-arm64-appimage
        path: PasswordManager-linux-arm64.AppImage

  create-release:
    runs-on: ubuntu-latest
    needs: [build-windows-x86_64, build-linux-arm64-appimage]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: windows-x86_64-exe
        path: artifacts/windows

    - name: Download Linux AppImage artifact
      uses: actions/download-artifact@v4
      with:
        name: linux-arm64-appimage
        path: artifacts/linux

    - name: Display file information
      run: |
        echo "=== ç”Ÿæˆçš„æ–‡ä»¶ ==="
        find artifacts -type f -exec ls -lh {} \;
        echo "=== æ–‡ä»¶è¯¦æƒ… ==="
        file artifacts/windows/* 2>/dev/null || true
        file artifacts/linux/* 2>/dev/null || true

    - name: Create GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          artifacts/windows/PasswordManager-windows-x86_64.exe
          artifacts/linux/PasswordManager-linux-arm64.AppImage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}