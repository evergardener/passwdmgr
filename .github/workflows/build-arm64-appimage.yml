name: Build ARM64 AppImage

on:
  push:
    tags: ['v*'] # 在推送版本标签时触发，例如 v1.0.0
  pull_request:
    branches: [main]
  # 你也可以手动触发工作流
  workflow_dispatch:

jobs:
  build:
    name: Build Python AppImage for ARM64
    runs-on: ubuntu-latest # 工作流控制环境，构建任务将在ARM64运行器执行
    strategy:
      matrix:
        # 使用 GitHub 托管的 ARM64 运行器
        include:
          - arch: arm64
            runner: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          # 安装必要的系统工具和库，包括FUSE（AppImage所需）[citation:4]
          sudo apt-get install -y fuse libfuse2 wget desktop-file-utils

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          # 确保PyInstaller已安装
          pip install pyinstaller

      - name: Download ARM64 appimagetool
        run: |
          # 下载适用于aarch64（ARM64）的appimagetool[citation:2]
          wget -O appimagetool.aarch64.AppImage https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage
          chmod +x appimagetool.aarch64.AppImage

      - name: Build with PyInstaller
        run: |
          # 使用PyInstaller打包应用，注意指定目标架构
          pyinstaller --name="PasswordManager" \
            --windowed \
            --onefile \
            --add-data="gui/*.py:gui" \
            --add-data="core/*.py:core" \
            --add-data="models/*.py:models" \
            --add-data="utils/*.py:utils" \
            --target-architecture=arm64 \
            main.py

      - name: Prepare AppDir
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # 将PyInstaller生成的可执行文件复制到AppDir
          cp dist/PasswordManager AppDir/usr/bin/

          # 如果有应用图标，也复制过去
          # cp icons/app_icon.png AppDir/usr/share/icons/hicolor/256x256/apps/password-manager.png

          # 创建桌面入口文件
          cat > AppDir/usr/share/applications/password-manager.desktop << EOF
          [Desktop Entry]
          Name=Password Manager
          Comment=A secure password manager application
          Exec=PasswordManager
          Icon=password-manager
          Type=Application
          Categories=Utility;Security;
          StartupNotify=true
          Terminal=false
          EOF

      - name: Create AppImage
        run: |
          # 使用appimagetool打包AppDir为AppImage
          ./appimagetool.aarch64.AppImage AppDir

          # 重命名生成的AppImage，包含架构和版本信息
          VERSION=${GITHUB_REF#refs/tags/v} # 从标签提取版本
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF" ]; then
            VERSION="latest"
          fi
          mv PasswordManager-*-aarch64.AppImage PasswordManager-${VERSION}-aarch64.AppImage

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: PasswordManager-ARM64
          path: PasswordManager-*-aarch64.AppImage
          retention-days: 30

      - name: Upload to Release (on tag push)
        # 仅在推送标签时，将AppImage附加到GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: PasswordManager-*-aarch64.AppImage